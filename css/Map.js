!function(a){a.fn.ylmap=function(b){a.fn.ylmap.defaults={detal:{sign_name:"TXjiang",contact_tel:18624443174,address:"天安门"},latitude:39.915,longitude:116.404,fnOpen:null,fnClose:null};var c=a.extend({},a.fn.ylmap.defaults,b);return this.each(function(){function w(){var b,c,d,f;a(".BDS").length<=0?(b=document.createElement("script"),b.src="http://api.map.baidu.com/api?v=1.4&callback=mapInit",b.className+="BDS",document.head.appendChild(b)):t(),a(".BDC").length<=0&&(c=document.createElement("style"),c.type="text/css",c.className+="BDC",d=x(),d?(mapScale=1,phoneScale=1):mapScale=phoneScale>1?1:1/phoneScale,a(window).height(),f=".ylmap.open,.ylmap.mapOpen {height:100%;width:100%;background:#fff;}.ylmap img {max-width:initial!important;}.ylmap .tit { position:absolute; left:0; bottom:0; height:70px; width:100%; overflow: hidden; background:rgba(0,0,0,0.5); }.ylmap .tit p { margin-right:100px; }.ylmap .tit p a { position:relative; display:block; font-size:24px; color:#fff; height:70px; line-height:70px; padding-left:70px; }.ylmap .tit p a span { position:absolute; left:15px; top:15px; display:inline-block; width:40px;height:40px; }.ylmap .tit .close_map { display:none; position: absolute; bottom: 15px; right: 20px; width: 40px; height: 40px; margin-right:0; cursor:pointer; background-position: -100px -73px; }.ylmap .map_close_btn{position:absolute;top:10px;left:10px;display:none;width:80px;box-shadow:0 0 2px rgba(0,0,0,0.6) inset, 0 0 2px rgba(0,0,0,0.6);height:80px;border-radius:80%;color:#fff;background:rgba(230,45,36,0.8);text-align:center;line-height:80px;font-size:26px; font-weight:bold;cursor:pointer;}.ylmap.open .map_close_btn{display:block;}.ylmap.mapOpen .map_close_btn{display:block;}#BDMap {transform:scale("+mapScale+");-webkit-transform:scale("+mapScale+");}"+"#BDMap {width:100%;height:100%;}"+"#BDMap img{width:auto;height:auto;}"+".ylmap.open .transitBtn{display:block;}"+".ylmap.mapOpen .transitBtn{display:block;}"+".transitBtn {display:none;position:absolute;z-index:3000;}"+".transitBtn a{display:block;width:80px;box-shadow:0 0 2px rgba(0,0,0,0.6) inset, 0 0 2px rgba(0,0,0,0.6);height:80px;border-radius:80%;color:#fff;background:rgba(230,45,36,0.8);text-align:center;line-height:80px;font-size:24px; font-weight:bold}"+".transitBtn.close {top:10px;right:10px;}"+".transitBtn.bus {top:10px;right:110px;}"+".transitBtn.car {top:110px;right:10px;}"+".transitBtn.bus a{background:rgba(28,237,235,0.8);}"+".transitBtn.car a{background:rgba(89,237,37,0.8);}"+"#transit_result{display:none;position:absolute;top:0;left:0;width:100%;height:100%;z-index:1000;overflow-y:scroll;}"+"#transit_result.open{display:block;}"+"#transit_result h1{font-size:26px!important;}"+"#transit_result div[onclick^='Instance']{background:none!important;}"+"#transit_result span{display:inline-block;font-size:20px;padding:0 5px;}"+"#transit_result table {font-size:20px!important;}"+"#transit_result table td{padding:5px 10px!important;line-height:150%!important;}"+".infoWindow p{margin-bottom:10px;}"+".infoWindow .window_btn .open_navigate{display:inline-block;padding:2px 6px; margin-right:10px;border:1px solid #ccc;border-radius:6px;text-align:center;cursor:pointer;}"+".anchorBL{display:none!important;}",c.innerHTML=f,document.head.appendChild(c))}function x(){var d,a=navigator.userAgent,b=new Array("Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"),c=!0;for(d=0;d<b.length;d++)if(a.indexOf(b[d])>0){c=!1;break}return c}var b,d,e,f,g,i,j,k,l,m,n,o,p,q,r,t,u,v;console.log(a(this)),b=a(this),d=c.detal,e=c.latitude,f=c.longitude,g=c.fnClose,c.fnOpen,i=b.hasClass("bigOpen"),j=null,k=null,l=null,m=null,r=a('<div id="BDMap" class="BDMap"></div>'),b.append(r),b.append(a('<div id="transit_result"></div>')),b.append(a('<div class="tit"><p><a href="javascript:void(0)"><span class="css_sprite01"></span>'+d.address+"</a></p></div>")),b.append(a('<p class="map_close_btn">退出</p>')),b.length>0&&b.height(),i&&b.find(".map_close_btn").css("display","block"),a("#transit_result").length>0&&""!=a("#transit_result").html()&&a(".transitBtn").removeClass("hide"),t=function(){b.size()>0&&(o=new BMap.Map(r.attr("id")),p=new BMap.Point(f,e),q=new BMap.Marker(p),o.enableScrollWheelZoom(),o.enableInertialDragging(),o.centerAndZoom(p,15),o.addOverlay(q),u(),q.addEventListener("click",function(){u()}),o.addEventListener("click",function(){return!1}),o.addEventListener("zoomend",function(){var b=o.getZoom();o.centerAndZoom(p,b)}))},u=function(){v(q,d)},v=function(b,c){var e,f,d=a('<div class="infoWindow"></div>');d.append("<h4>"+c.sign_name+"</h4>"),"undefined"!=typeof c.contact_tel&&d.append('<p class="tel"><a href="tel:'+c.contact_tel+'">'+c.contact_tel+"</a></p>"),d.append('<p class="address">'+c.address+"</p>"),d.append('<div class="window_btn"><span class="open_navigate open_bus" onclick="open_navigate(this)">公交</span><span class="open_navigate open_car" onclick="open_navigate(this)">自驾</span><span class="State"></span></div>'),e={width:0,height:0,title:" "},f=new BMap.InfoWindow(d[0],e),b.openInfoWindow(f,o.getCenter())},open_navigate=function(b){j=a(b).hasClass("open_bus")?"bus":"car",navigate(),a(".infoWindow").find("span.State").html("正在定位您的位置！")},navigate=function(){window.navigator.geolocation?window.navigator.geolocation.getCurrentPosition(handleSuccess,handleError,{timeout:1e4}):alert("sorry！您的设备不支持定位功能")},handleError=function(b){var c;switch(b.code){case b.TIMEOUT:c="获取超时!请稍后重试!";break;case b.POSITION_UNAVAILABLE:c="无法获取当前位置!";break;case b.PERMISSION_DENIED:c="您已拒绝共享地理位置!";break;case b.UNKNOWN_ERROR:c="无法获取当前位置!"}a(".infoWindow").find("span.State").length>0?a(".infoWindow").find("span.State").html(c):alert(c)},handleSuccess=function(b){var c=b.coords,d=c.latitude,e=c.longitude;m=new BMap.Point(e,d),a(".infoWindow").find("span.State").html("获取信息成功，正在加载中！"),"bus"==j?bus_transit():self_transit(),i?r.parent().addClass("mapOpen"):r.parent().addClass("open")},a(".map_close_btn").on("click",function(){b.removeClass("mapOpen open"),g&&g()}),bus_transit=function(){if(k&&k.clearResults(),l&&l.clearResults(),!m)return alert("抱歉：定位失败！"),void 0;a(".fn-audio").hide(),"function"==typeof loadingPageShow&&loadingPageShow(),a(".infoWindow").find("span.State").html("正在绘制出导航路线");var c=a("#transit_result")||a('<div id="transit_result"></div>');c.appendTo(b),k=new BMap.TransitRoute(o,{renderOptions:{map:o,panel:"transit_result",autoViewport:!0},onSearchComplete:searchComplete}),k.search(m,p)},self_transit=function(){if(k&&k.clearResults(),l&&l.clearResults(),!m)return alert("抱歉：定位失败！"),void 0;a(".fn-audio").hide(),"function"==typeof loadingPageShow&&loadingPageShow(),a(".infoWindow").find("span.State").html("正在绘制出导航路线");var c=a("#transit_result")||a('<div id="transit_result"></div>');c.appendTo(b),l=new BMap.DrivingRoute(o,{renderOptions:{map:o,panel:c.attr("id"),autoViewport:!0},onSearchComplete:searchComplete}),l.search(m,p)},searchComplete=function(c){function d(){var b;b=window.event.touches[0].pageY,n=b}function e(b){var c,d;b.stopPropagation(),b.preventDefault(),c=window.event.touches[0].pageY,d=a(this).scrollTop(),a(this).scrollTop(d+n-c),n=c}0==c.getNumPlans()?(alert("非常抱歉,未搜索到可用路线"),o.reset(),o.centerAndZoom(p,15),u(),a("#transit_result").removeClass("open").hide(),a(".transitBtn").hide()):(a("#transit_result").addClass("open"),a(".infoWindow").find("span.State").html(""),!a(".transitBtn").length>0&&(a("#transit_result").after(a('<p class="transitBtn close" onclick="transit_result_close()"><a href="javascript:void(0)">关闭</a></p>')),a("#transit_result").after(a('<p class="transitBtn bus" onclick="bus_transit()"><a href="javascript:void(0)">公交</a></p>')),a("#transit_result").after(a('<p class="transitBtn car" onclick="self_transit()"><a href="javascript:void(0)">自驾</a></p>'))),b.find(".close_map").show(),a("#transit_result").addClass("open"),a(".transitBtn").show(),a("#transit_result").on("touchstart",d),a("#transit_result").on("touchmove",e)),"function"==typeof loadingPageHide&&loadingPageHide(),i||b.css({position:"fixed",top:"0",left:"0",height:"100%"}),a("#transit_result").hasClass("open")?a(".close").find("a").html("关闭"):a(".close").find("a").html("打开")},transit_result_close=function(){a("#transit_result").hasClass("open")?(a("#transit_result").removeClass("open"),a(".close").find("a").html("打开")):(a("#transit_result").addClass("open"),a(".close").find("a").html("关闭"))},window.mapInit=t,w()})}}(Zepto);